version: '3.8'

x-base:
  &base # NOTE: A imagem será substituída dinamicamente pelo CI/CD para garantir rollback
  image: ghcr.io/cauefaleiros/chatwoot:latest
  volumes:
    - storage_data:/app/storage
  environment:
    - RAILS_ENV=production
    - NODE_ENV=production
    - RAILS_LOG_TO_STDOUT=true
    - RAILS_SERVE_STATIC_FILES=true
    # ... (demais variáveis injetadas pelo Portainer continuam funcionado) ...

services:
  rails:
    <<: *base
    depends_on:
      - postgres
      - redis
    ports:
      - '3010:3000'
    entrypoint: docker/entrypoints/rails.sh
    # Executa prepare (migrations) e sobe o server.
    # O '&&' garante que o server só sobe se a migration passar.
    command:
      [
        'sh',
        '-c',
        'bundle exec rails db:chatwoot_prepare && bundle exec rails s -p 3000 -b 0.0.0.0',
      ]

    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget --no-verbose --tries=1 --spider http://localhost:3000/hc || exit 1',
        ]
      interval: 30s # Aumentado para reduzir carga
      timeout: 10s
      retries: 5
      start_period: 120s # CRÍTICO: Dá 2 minutos pro Rails subir e rodar migrations antes de falhar

    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 30s
        order: start-first # Sobe o novo, espera ficar saudável, depois mata o velho
        failure_action: rollback
        monitor: 150s # Tempo para monitorar se o novo deploy ficou estável (maior que o start_period)
      rollback_config:
        parallelism: 1
        order: stop-first
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      labels:
        - 'com.docker.swarm.image.pull=always'

  sidekiq:
    <<: *base
    depends_on:
      - postgres
      - redis
    command: ['bundle', 'exec', 'sidekiq', '-C', 'config/sidekiq.yml']

    healthcheck:
      test: ['CMD-SHELL', 'pgrep -f sidekiq || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s # CRÍTICO: Sidekiq também demora pra carregar o ambiente Rails

    deploy:
      replicas: 1
      update_config:
        order: start-first
        failure_action: rollback
        monitor: 150s
      restart_policy:
        condition: on-failure
      labels:
        - 'com.docker.swarm.image.pull=always'

  # ... (postgres e redis mantêm-se iguais) ...
  postgres:
    image: pgvector/pgvector:pg16
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DATABASE}
      - POSTGRES_USER=${POSTGRES_USERNAME}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    deploy:
      restart_policy:
        condition: on-failure

  redis:
    image: redis:alpine
    command: ['sh', '-c', 'redis-server --requirepass "$REDIS_PASSWORD"']
    volumes:
      - redis_data:/data
    ports:
      - '6379:6379'
    deploy:
      restart_policy:
        condition: on-failure

volumes:
  storage_data:
  postgres_data:
  redis_data:

networks:
  default:
    driver: overlay
