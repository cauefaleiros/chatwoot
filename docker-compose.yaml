version: '3.8'

# --- Definição Base (x-base) ---
# Usamos 'x-base' para não criar um container extra inútil, apenas servindo de molde.
x-base: &base
  image: ghcr.io/fazer-ai/chatwoot:v4.10.0-fazer-ai.15
  volumes:
    - storage_data:/app/storage
  environment:
    - RAILS_ENV=${RAILS_ENV}
    - NODE_ENV=production
    - SECRET_KEY_BASE=${SECRET_KEY_BASE}
    - FRONTEND_URL=${FRONTEND_URL}
    - POSTGRES_HOST=${POSTGRES_HOST}
    - POSTGRES_PORT=${POSTGRES_PORT}
    - POSTGRES_DATABASE=${POSTGRES_DATABASE}
    - POSTGRES_USERNAME=${POSTGRES_USERNAME}
    - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    - REDIS_URL=${REDIS_URL}
    - REDIS_PASSWORD=${REDIS_PASSWORD}
    - MAILER_SENDER_EMAIL=${MAILER_SENDER_EMAIL}
    - SMTP_ADDRESS=${SMTP_ADDRESS}
    - SMTP_PORT=${SMTP_PORT}
    - SMTP_USERNAME=${SMTP_USERNAME}
    - SMTP_PASSWORD=${SMTP_PASSWORD}
    - SMTP_AUTHENTICATION=${SMTP_AUTHENTICATION}
    - SMTP_ENABLE_STARTTLS_AUTO=${SMTP_ENABLE_STARTTLS_AUTO}
    - ACTIVE_STORAGE_SERVICE=${ACTIVE_STORAGE_SERVICE}
    - FORCE_SSL=${FORCE_SSL}
    - RAILS_LOG_TO_STDOUT=true
    - RAILS_SERVE_STATIC_FILES=true

services:
  # --- Aplicação Principal (Rails) ---
  rails:
    <<: *base
    depends_on:
      - postgres
      - redis
    ports:
      # Mapeia a porta 3010 do host para a 3000 do container
      - "3010:3000"
    entrypoint: docker/entrypoints/rails.sh
    # CORREÇÃO CRÍTICA AQUI:
    # O comando abaixo roda 'db:chatwoot_prepare' para criar o banco se ele não existir
    # e depois sobe o servidor. Sem isso, dá erro de 'UndefinedTable'.
    command: ['sh', '-c', 'bundle exec rails db:chatwoot_prepare && bundle exec rails s -p 3000 -b 0.0.0.0']
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # --- Processamento de Fundo (Sidekiq) ---
  sidekiq:
    <<: *base
    depends_on:
      - postgres
      - redis
    command: ['bundle', 'exec', 'sidekiq', '-C', 'config/sidekiq.yml']
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # --- Banco de Dados (Postgres) ---
  postgres:
    image: pgvector/pgvector:pg16
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DATABASE}
      - POSTGRES_USER=${POSTGRES_USERNAME}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    deploy:
      restart_policy:
        condition: on-failure

  # --- Cache (Redis) ---
  redis:
    image: redis:alpine
    command: ["sh", "-c", "redis-server --requirepass \"$REDIS_PASSWORD\""]
    volumes:
      - redis_data:/data
    ports:
      - '6379:6379'
    deploy:
      restart_policy:
        condition: on-failure

volumes:
  storage_data:
  postgres_data:
  redis_data:

networks:
  default:
    driver: overlay
